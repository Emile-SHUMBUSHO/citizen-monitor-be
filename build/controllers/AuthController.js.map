{"version":3,"file":"AuthController.js","names":["AuthLocalController","req","res","body","password","helper","hash","Create","response","status","CREATED","json","BAD_REQUEST","send","error","email","code","otp","generate","data","template","account","sendEmailOtp","message","subject","sendEmail","FindOne","Object","keys","length","NOT_FOUND","firstName","lastName","phoneNumber","ID","province","district","sector","cell","newPassword","userId","id","user","Delete","name","EXIST","auth","profile","comparePassword","compare","UNAUTHORIZED","payload","token","OK"],"sources":["../../src/controllers/AuthController.js"],"sourcesContent":["import 'dotenv/config'\nimport otp from 'generate-otp'\nimport * as helper from '../helpers'\nimport * as template from '../templates'\nimport status from '../config/status'\nimport { Create, FindOne, Delete } from '../database/queries'\nimport sendEmail from '../helpers/mailer/mail'\n\n/**\n * A class to handle user local authentication\n */\nexport default class AuthLocalController {\n  /**\n   * @description user signup function\n   * @param {object} req request from user\n   * @param {object} res response from server\n   * @return {object} user information & token\n   */\n  static async signup(req, res) {\n    req.body.password = helper.password.hash(req.body.password)\n    try {\n      const response = await Create('User', req.body)\n      return (\n        delete response.password &&\n        res.status(status.CREATED).json({ response })\n      )\n    } catch (error) {\n      return res.status(status.BAD_REQUEST).send({\n        error:\n          'Sorry, we can not create your account right now. Try again later',\n      })\n    }\n  }\n  static async registerEmail(req, res) {\n    const { email } = req.body\n    const code = otp.generate(6)\n    const data = {\n      email,\n      code,\n    }\n    try {\n      const response = await Create('VerifyEmail', data)\n      const { message, subject } = template.account.sendEmailOtp(data.code)\n      await sendEmail(response, message, subject)\n      return res\n        .status(status.CREATED)\n        .json({ response: { email: response.email } })\n    } catch (error) {\n      return res.status(status.BAD_REQUEST).send({\n        error: error.message,\n          // 'Sorry, we can not create your account right now. Try again later',\n          \n      })\n    }\n  }\n  static async registerVerify(req, res) {\n    const { email, code } = req.body\n    const response = await FindOne('VerifyEmail', {\n      email,\n      code,\n    })\n    if(Object.keys(response).length === 0){\n      return res.status(status.NOT_FOUND).send({\n          error: 'Sorry, we can not find the OTP you provided, try again later',\n        })\n    } \n    return res.status(status.CREATED).json({ response })\n  }\n\n  static async registerComplete(req, res) {\n    const {\n      email,\n      code,\n      password,\n      firstName,\n      lastName,\n      phoneNumber,\n      ID,\n      province,\n      district,\n      sector,\n      cell,\n    } = req.body\n    try {\n      // 1. REGISTER A USER\n      const newPassword = helper.password.hash(password)\n      const response = await Create('User', {\n        password: newPassword,\n        email,\n      })\n      // 2. CREATE USER PROFILE INFO\n      const user = await Create('Profile', {\n        userId: response.id,\n        firstName,\n        lastName,\n        ID,\n        phoneNumber,\n        province,\n        district,\n        sector,\n        cell\n      })\n      // 3. CHECK AND DELETE OTP CODE\n      await Delete('VerifyEmail', {\n        email,\n        code,\n      })\n      return (\n        delete response.password &&\n        res.status(status.CREATED).json({ response })\n      )\n    } catch (error) {\n      // IF NOT REGISTERED, ROLL BACK\n      await Delete('User', {\n        email,\n      })\n      // IF ERROR IS UNIQUE CONSTRAINT\n      if (error.name === 'SequelizeUniqueConstraintError') {\n        return res.status(status.EXIST).send({\n          error: 'Account with email or phone number already exists',\n        })\n      }\n\n      return res.status(status.BAD_REQUEST).send({\n        error:\n          'Sorry, we can not register your account at this moment. Refresh the page and try again',\n          message: error.message,\n      })\n    }\n  }\n\n  static async login(req, res) {\n    const { password } = req.body\n    const user = req.auth\n\n    // get profile info\n    const profile = await FindOne('Profile', {\n      userId: user.id,\n    })\n    if (Object.keys(user).length > 0) {\n      const comparePassword = helper.password.compare(\n        password,\n        user.password || ''\n      )\n      if (!comparePassword) {\n        return res.status(status.UNAUTHORIZED).json({\n          error: 'The credentials you provided are incorrect',\n        })\n      }\n      const payload = {\n        id: user.id,\n      }\n      const token = helper.token.generate(payload)\n      delete user.password\n      return (\n        user &&\n        profile &&\n        res.status(status.OK).json({\n          user,\n          profile,\n          token,\n        })\n      )\n    } else {\n      return res.status(status.UNAUTHORIZED).json({\n        error: 'The credentials you provided are incorrect',\n      })\n    }\n  }\n\n  static async getUser(req, res) {\n    return req.user\n      ? delete req.user.password &&\n          res.status(status.OK).json({\n            user: req.user,\n          })\n      : res.status(status.NOT_FOUND).send({\n          error: 'The account is not found at this moment.',\n        })\n  }\n}\n"],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAA8C;AAAA;AAE9C;AACA;AACA;AAFA,IAGqBA,mBAAmB;EAAA;IAAA;EAAA;EAAA;IAAA;IAAA;IACtC;AACF;AACA;AACA;AACA;AACA;IALE;MAAA,4FAMA,iBAAoBC,GAAG,EAAEC,GAAG;QAAA;QAAA;UAAA;YAAA;cAAA;gBAC1BD,GAAG,CAACE,IAAI,CAACC,QAAQ,GAAGC,MAAM,CAACD,QAAQ,CAACE,IAAI,CAACL,GAAG,CAACE,IAAI,CAACC,QAAQ,CAAC;gBAAA;gBAAA;gBAAA,OAElC,IAAAG,eAAM,EAAC,MAAM,EAAEN,GAAG,CAACE,IAAI,CAAC;cAAA;gBAAzCK,QAAQ;gBAAA,iCAEZ,OAAOA,QAAQ,CAACJ,QAAQ,IACxBF,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC;kBAAEH,QAAQ,EAARA;gBAAS,CAAC,CAAC;cAAA;gBAAA;gBAAA;gBAAA,iCAGxCN,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACG,WAAW,CAAC,CAACC,IAAI,CAAC;kBACzCC,KAAK,EACH;gBACJ,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEL;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,mGACD,kBAA2Bb,GAAG,EAAEC,GAAG;QAAA;QAAA;UAAA;YAAA;cAAA;gBACzBa,KAAK,GAAKd,GAAG,CAACE,IAAI,CAAlBY,KAAK;gBACPC,IAAI,GAAGC,uBAAG,CAACC,QAAQ,CAAC,CAAC,CAAC;gBACtBC,IAAI,GAAG;kBACXJ,KAAK,EAALA,KAAK;kBACLC,IAAI,EAAJA;gBACF,CAAC;gBAAA;gBAAA;gBAAA,OAEwB,IAAAT,eAAM,EAAC,aAAa,EAAEY,IAAI,CAAC;cAAA;gBAA5CX,QAAQ;gBAAA,wBACeY,QAAQ,CAACC,OAAO,CAACC,YAAY,CAACH,IAAI,CAACH,IAAI,CAAC,EAA7DO,OAAO,yBAAPA,OAAO,EAAEC,OAAO,yBAAPA,OAAO;gBAAA;gBAAA,OAClB,IAAAC,gBAAS,EAACjB,QAAQ,EAAEe,OAAO,EAAEC,OAAO,CAAC;cAAA;gBAAA,kCACpCtB,GAAG,CACPO,MAAM,CAACA,kBAAM,CAACC,OAAO,CAAC,CACtBC,IAAI,CAAC;kBAAEH,QAAQ,EAAE;oBAAEO,KAAK,EAAEP,QAAQ,CAACO;kBAAM;gBAAE,CAAC,CAAC;cAAA;gBAAA;gBAAA;gBAAA,kCAEzCb,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACG,WAAW,CAAC,CAACC,IAAI,CAAC;kBACzCC,KAAK,EAAE,aAAMS;kBACX;gBAEJ,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEL;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,oGACD,kBAA4BtB,GAAG,EAAEC,GAAG;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA,YACVD,GAAG,CAACE,IAAI,EAAxBY,KAAK,aAALA,KAAK,EAAEC,IAAI,aAAJA,IAAI;gBAAA;gBAAA,OACI,IAAAU,gBAAO,EAAC,aAAa,EAAE;kBAC5CX,KAAK,EAALA,KAAK;kBACLC,IAAI,EAAJA;gBACF,CAAC,CAAC;cAAA;gBAHIR,QAAQ;gBAAA,MAIXmB,MAAM,CAACC,IAAI,CAACpB,QAAQ,CAAC,CAACqB,MAAM,KAAK,CAAC;kBAAA;kBAAA;gBAAA;gBAAA,kCAC5B3B,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACqB,SAAS,CAAC,CAACjB,IAAI,CAAC;kBACrCC,KAAK,EAAE;gBACT,CAAC,CAAC;cAAA;gBAAA,kCAECZ,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC;kBAAEH,QAAQ,EAARA;gBAAS,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CACrD;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,sGAED,kBAA8BP,GAAG,EAAEC,GAAG;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA,aAahCD,GAAG,CAACE,IAAI,EAXVY,KAAK,cAALA,KAAK,EACLC,IAAI,cAAJA,IAAI,EACJZ,QAAQ,cAARA,QAAQ,EACR2B,SAAS,cAATA,SAAS,EACTC,QAAQ,cAARA,QAAQ,EACRC,WAAW,cAAXA,WAAW,EACXC,EAAE,cAAFA,EAAE,EACFC,QAAQ,cAARA,QAAQ,EACRC,QAAQ,cAARA,QAAQ,EACRC,MAAM,cAANA,MAAM,EACNC,IAAI,cAAJA,IAAI;gBAAA;gBAGJ;gBACMC,WAAW,GAAGlC,MAAM,CAACD,QAAQ,CAACE,IAAI,CAACF,QAAQ,CAAC;gBAAA;gBAAA,OAC3B,IAAAG,eAAM,EAAC,MAAM,EAAE;kBACpCH,QAAQ,EAAEmC,WAAW;kBACrBxB,KAAK,EAALA;gBACF,CAAC,CAAC;cAAA;gBAHIP,QAAQ;gBAAA;gBAAA,OAKK,IAAAD,eAAM,EAAC,SAAS,EAAE;kBACnCiC,MAAM,EAAEhC,QAAQ,CAACiC,EAAE;kBACnBV,SAAS,EAATA,SAAS;kBACTC,QAAQ,EAARA,QAAQ;kBACRE,EAAE,EAAFA,EAAE;kBACFD,WAAW,EAAXA,WAAW;kBACXE,QAAQ,EAARA,QAAQ;kBACRC,QAAQ,EAARA,QAAQ;kBACRC,MAAM,EAANA,MAAM;kBACNC,IAAI,EAAJA;gBACF,CAAC,CAAC;cAAA;gBAVII,IAAI;gBAAA;gBAAA,OAYJ,IAAAC,eAAM,EAAC,aAAa,EAAE;kBAC1B5B,KAAK,EAALA,KAAK;kBACLC,IAAI,EAAJA;gBACF,CAAC,CAAC;cAAA;gBAAA,kCAEA,OAAOR,QAAQ,CAACJ,QAAQ,IACxBF,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC;kBAAEH,QAAQ,EAARA;gBAAS,CAAC,CAAC;cAAA;gBAAA;gBAAA;gBAAA;gBAAA,OAIzC,IAAAmC,eAAM,EAAC,MAAM,EAAE;kBACnB5B,KAAK,EAALA;gBACF,CAAC,CAAC;cAAA;gBAAA,MAEE,aAAM6B,IAAI,KAAK,gCAAgC;kBAAA;kBAAA;gBAAA;gBAAA,kCAC1C1C,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACoC,KAAK,CAAC,CAAChC,IAAI,CAAC;kBACnCC,KAAK,EAAE;gBACT,CAAC,CAAC;cAAA;gBAAA,kCAGGZ,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACG,WAAW,CAAC,CAACC,IAAI,CAAC;kBACzCC,KAAK,EACH,wFAAwF;kBACxFS,OAAO,EAAE,aAAMA;gBACnB,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEL;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,2FAED,kBAAmBtB,GAAG,EAAEC,GAAG;QAAA;QAAA;UAAA;YAAA;cAAA;gBACjBE,QAAQ,GAAKH,GAAG,CAACE,IAAI,CAArBC,QAAQ;gBACVsC,IAAI,GAAGzC,GAAG,CAAC6C,IAAI,EAErB;gBAAA;gBAAA,OACsB,IAAApB,gBAAO,EAAC,SAAS,EAAE;kBACvCc,MAAM,EAAEE,IAAI,CAACD;gBACf,CAAC,CAAC;cAAA;gBAFIM,OAAO;gBAAA,MAGTpB,MAAM,CAACC,IAAI,CAACc,IAAI,CAAC,CAACb,MAAM,GAAG,CAAC;kBAAA;kBAAA;gBAAA;gBACxBmB,eAAe,GAAG3C,MAAM,CAACD,QAAQ,CAAC6C,OAAO,CAC7C7C,QAAQ,EACRsC,IAAI,CAACtC,QAAQ,IAAI,EAAE,CACpB;gBAAA,IACI4C,eAAe;kBAAA;kBAAA;gBAAA;gBAAA,kCACX9C,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACyC,YAAY,CAAC,CAACvC,IAAI,CAAC;kBAC1CG,KAAK,EAAE;gBACT,CAAC,CAAC;cAAA;gBAEEqC,OAAO,GAAG;kBACdV,EAAE,EAAEC,IAAI,CAACD;gBACX,CAAC;gBACKW,KAAK,GAAG/C,MAAM,CAAC+C,KAAK,CAAClC,QAAQ,CAACiC,OAAO,CAAC;gBAC5C,OAAOT,IAAI,CAACtC,QAAQ;gBAAA,kCAElBsC,IAAI,IACJK,OAAO,IACP7C,GAAG,CAACO,MAAM,CAACA,kBAAM,CAAC4C,EAAE,CAAC,CAAC1C,IAAI,CAAC;kBACzB+B,IAAI,EAAJA,IAAI;kBACJK,OAAO,EAAPA,OAAO;kBACPK,KAAK,EAALA;gBACF,CAAC,CAAC;cAAA;gBAAA,kCAGGlD,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACyC,YAAY,CAAC,CAACvC,IAAI,CAAC;kBAC1CG,KAAK,EAAE;gBACT,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEL;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,6FAED,kBAAqBb,GAAG,EAAEC,GAAG;QAAA;UAAA;YAAA;cAAA;gBAAA,kCACpBD,GAAG,CAACyC,IAAI,GACX,OAAOzC,GAAG,CAACyC,IAAI,CAACtC,QAAQ,IACtBF,GAAG,CAACO,MAAM,CAACA,kBAAM,CAAC4C,EAAE,CAAC,CAAC1C,IAAI,CAAC;kBACzB+B,IAAI,EAAEzC,GAAG,CAACyC;gBACZ,CAAC,CAAC,GACJxC,GAAG,CAACO,MAAM,CAACA,kBAAM,CAACqB,SAAS,CAAC,CAACjB,IAAI,CAAC;kBAChCC,KAAK,EAAE;gBACT,CAAC,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CACP;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;EAAA;AAAA;AAAA"}